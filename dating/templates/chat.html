<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Chat - Dating App{% endblock %}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        .chat-sidebar {
            background-color: #fff;
            width: 280px;
            padding: 20px;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.06);
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100vh; /* Make sidebar full height */
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-profile-picture-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e9ecef;
        }

        .sidebar-profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-profile-info h6 {
            margin-bottom: 0;
            font-size: 1em;
            color: #333;
        }

        .sidebar-navigation button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .sidebar-navigation button:hover {
            background-color: #0056b3;
        }

        .matches-list-header {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .match-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .match-item:last-child {
            border-bottom: none;
        }

        .match-item:hover {
            background-color: #f8f9fa;
        }

        .match-item-picture-container {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e9ecef;
        }

        .match-item-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .match-item-info h6 {
            margin-bottom: 0;
            font-size: 0.9em;
            color: #333;
        }

        .chat-area {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-color: #f0f2f5;
        }

        #chat-display {
            overflow-y: auto;
            padding: 10px;
        }

        .message-container {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            clear: both; /* Prevent floating issues */
        }

        .user-message {
            background-color: #e2f7cb;
            float: right;
            text-align: right;
        }

        .other-message {
            background-color: #fff;
            float: left;
            text-align: left;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            background-color: #e9ecef;
            border-top: 1px solid #ddd;
        }

        #chat-message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        #chat-send-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #chat-send-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="chat-sidebar">
        <div class="sidebar-profile">
            <div class="sidebar-profile-picture-container">
                {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename='uploads/' ~ current_user.profile_picture) }}" alt="Your Profile">
                {% else %}
                <span>{{ current_user.first_name|first }}</span> {% endif %}
            </div>
            <div class="sidebar-profile-info">
                <h6>{{ current_user.first_name }}</h6>
            </div>
        </div>

        <div class="sidebar-navigation">
            <button onclick="window.location.href='/profile'">Profile</button>
            <button class="active">Messages</button>
            <button onclick="window.location.href='/matches'">Matches</button> <button onclick="window.location.href='/logout'">Logout</button>
        </div>

        <h6 class="matches-list-header">Recent Matches</h6>
        <div id="matches-list">
<div id="matches-list">
    {% if matches %}
        {% for item in matches %}
            <div class="match-item" onclick="loadChat('{{ item.user.user_id }}', '{{ item.user.first_name }}')">
                <div class="match-item-picture-container">
                    {% if item.user.profile_picture %}
                        <img src="{{ url_for('static', filename='uploads/' ~ item.user.profile_picture) }}" alt="{{ item.user.first_name }}">
                    {% else %}
                        <span>{{ item.user.first_name[0] }}</span>
                    {% endif %}
                </div>
                <div class="match-item-info">
                    <h6>{{ item.user.first_name }}</h6>
                    {# คุณสามารถเข้าถึงข้อมูล Match ได้จาก item.match เช่น: #}
                    {# <p class="text-muted">Match ID: {{ item.match.match_id }}</p> #}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-muted">No recent matches.</p>
    {% endif %}
</div>
        </div>
    </div>

    <div class="chat-area">
        <div id="chat-display">
            <p class="text-center text-muted">Select a chat to view messages.</p>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-message-input" placeholder="Enter your message">
            <button id="chat-send-button">Send</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io(); // Initialize SocketIO client
        const chatForm = document.querySelector('.chat-input-area');
        const messageInput = document.getElementById('chat-message-input');
        const chatDisplay = document.getElementById('chat-display');
        const matchesListDiv = document.getElementById('matches-list');
        let currentChatUserId = null;
        let currentChatUserName = null;
        const currentLoggedInUserId = {{ current_user.user_id }}; // Use current_user.user_id

        function loadChat(userId, userName) {
            console.log(`Loading chat with ${userName} (ID: ${userId})`);
            currentChatUserId = userId;
            currentChatUserName = userName;
            chatDisplay.innerHTML = `<p class="text-center text-muted">Loading chat with ${userName}...</p>`;

            // Join the SocketIO room for this chat
            const room = [currentLoggedInUserId, userId].sort().join('-');
            socket.emit('join_chat', { user_id: currentLoggedInUserId, room: room });

            // Fetch existing messages for this chat via AJAX (you'll need a Flask route for this)
            fetch(`/get_messages/${userId}`)
                .then(response => response.json())
                .then(messages => {
                    chatDisplay.innerHTML = '';
                    messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message-container', msg.sender_id === currentLoggedInUserId ? 'user-message' : 'other-message', 'mb-2', 'p-2', 'rounded');
                        messageDiv.textContent = msg.message;
                        chatDisplay.appendChild(messageDiv);
                    });
                    chatDisplay.scrollTop = chatDisplay.scrollHeight;
                });
        }

        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (message && currentChatUserId) {
                console.log(`Sending message to ${currentChatUserName} (ID: ${currentChatUserId}): ${message}`);
                socket.emit('send_message', {
                    sender_id: currentLoggedInUserId,
                    recipient_id: currentChatUserId,
                    message: message
                });
                messageInput.value = ''; // Clear the input
            } else if (!currentChatUserId) {
                alert('Please select a chat to send a message.');
            }
        });

        // Listen for 'receive_message' events from the server
        socket.on('receive_message', function(data) {
            if (data.sender_id !== currentLoggedInUserId && (data.sender_id == currentChatUserId || data.sender_id == currentLoggedInUserId) && (currentChatUserId == data.sender_id || currentChatUserId == currentLoggedInUserId)) {
                const newMessage = document.createElement('div');
                newMessage.classList.add('message-container', 'other-message', 'mb-2', 'p-2', 'rounded');
                newMessage.textContent = data.message;
                chatDisplay.appendChild(newMessage);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }
        });

        // You might want to emit an event when a user connects to the chat page
        socket.on('connect', function() {
            console.log('Connected to WebSocket');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from WebSocket');
        });

        
    </script>
</body>
</html>