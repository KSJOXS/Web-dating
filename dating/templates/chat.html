<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Chat - Dating App{% endblock %}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        .chat-sidebar {
            background-color: #fff;
            width: 280px;
            padding: 20px;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.06);
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100vh; /* Make sidebar full height */
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-profile-picture-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e9ecef;
        }

        .sidebar-profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-profile-info h6 {
            margin-bottom: 0;
            font-size: 1em;
            color: #333;
        }

        .sidebar-navigation button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .sidebar-navigation button:hover {
            background-color: #0056b3;
        }

        .matches-list-header {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .match-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .match-item:last-child {
            border-bottom: none;
        }

        .match-item:hover {
            background-color: #f8f9fa;
        }

        .match-item-picture-container {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e9ecef;
        }

        .match-item-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .match-item-info h6 {
            margin-bottom: 0;
            font-size: 0.9em;
            color: #333;
        }

        .chat-area {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-color: #f0f2f5;
        }

        #chat-display {
            flex-grow: 1; /* Allow chat display to take available space */
            overflow-y: auto;
            padding: 10px;
            display: flex; /* ใช้ flexbox เพื่อจัดเรียงข้อความ */
            flex-direction: column; /* จัดเรียงจากบนลงล่าง */
        }

        /* Message styling */
        .message-item {
            display: flex;
            flex-direction: column; /* ข้อความและ timestamp อยู่ในแนวตั้ง */
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            max-width: 70%; /* Limit message width */
            word-wrap: break-word; /* Break long words */
        }

        .my-message {
            background-color: #e2f7cb; /* สีข้อความของฉัน */
            align-self: flex-end; /* จัดชิดขวาใน flex container */
            margin-left: auto; /* ดันไปขวา */
        }

        .other-message {
            background-color: #fff; /* สีข้อความของคนอื่น */
            align-self: flex-start; /* จัดชิดซ้ายใน flex container */
            margin-right: auto; /* ดันไปซ้าย */
        }
        .message-content {
            font-size: 0.9em;
            margin-bottom: 2px;
        }
        .message-timestamp {
            font-size: 0.75em;
            color: #888;
            align-self: flex-end; /* จัด timestamp ชิดขวาเสมอ ไม่ว่าจะข้อความใคร */
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            background-color: #e9ecef;
            border-top: 1px solid #ddd;
            align-items: center; /* Vertically align items */
        }

        #chat-message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        #chat-send-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #chat-send-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="chat-sidebar">
        <div class="sidebar-profile">
            <div class="sidebar-profile-picture-container">
                {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename='uploads/' ~ current_user.profile_picture) }}" alt="Your Profile">
                {% else %}
                <span>{{ current_user.first_name[0] if current_user.first_name else '?' }}</span> {% endif %} {# Added condition for first_name #}
            </div>
            <div class="sidebar-profile-info">
                <h6>{{ current_user.first_name }}</h6>
            </div>
        </div>

        <div class="sidebar-navigation">
            <button onclick="window.location.href='/profile'">Profile</button>
            <button class="active">Messages</button>
            <button onclick="window.location.href='/matches'">Matches</button>
            <button onclick="window.location.href='/logout'">Logout</button>
        </div>

        <h6 class="matches-list-header">Recent Matches</h6>
        
        <div id="matches-list">
        {% if matches %}
            {% for match_info in matches %} {# Renamed variable to avoid confusion #}
                {# Add checks for existence of user and user_id/first_name within match_info.user #}
                {% if match_info.user and match_info.user.user_id and match_info.user.first_name %}
                <div class="match-item" onclick="loadChat('{{ match_info.user.user_id }}', '{{ match_info.user.first_name }}')">
                    <div class="match-item-picture-container">
                        {% if match_info.user.profile_picture %}
                            <img src="{{ url_for('static', filename='uploads/' ~ match_info.user.profile_picture) }}" alt="{{ match_info.user.first_name }}">
                        {% else %}
                            <span>{{ match_info.user.first_name[0] }}</span>
                        {% endif %}
                    </div>
                    <div class="match-item-info">
                        <h6>{{ match_info.user.first_name }}</h6>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="text-muted">No recent matches.</p>
        {% endif %}
        </div>
    </div>

    <div class="chat-area">
        <div id="chat-display">
            <p class="text-center text-muted">Select a chat to view messages.</p>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-message-input" placeholder="Enter your message">
            <button id="chat-send-button">Send</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io(); // Initialize SocketIO client
        const messageInput = document.getElementById('chat-message-input');
        const sendButton = document.getElementById('chat-send-button'); // Get the send button
        const chatDisplay = document.getElementById('chat-display');
        
        let currentChatUserId = null;
        let currentChatUserName = null;
        const currentLoggedInUserId = {{ current_user.user_id | tojson }}; // Correctly pass current_user.user_id as JSON

        function addMessageToDisplay(message, senderId, timestamp) {
            const messageDiv = document.createElement('div');
            // ใช้ class 'message-item' และ 'my-message'/'other-message'
            const isMyMessage = (senderId == currentLoggedInUserId); 
            messageDiv.classList.add('message-item');
            if (isMyMessage) {
                messageDiv.classList.add('my-message');
            } else {
                messageDiv.classList.add('other-message');
            }

            const date = new Date(timestamp);
            // ปรับ format เวลาให้เป็น HH:MM
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-timestamp">${timeString}</div>
            `;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function loadChat(userId, userName) {
            console.log(`Loading chat with ${userName} (ID: ${userId})`);
            
            // ถ้ามีการเปลี่ยนห้องแชท ให้ส่ง leave_chat ออกไปก่อน
            if (currentChatUserId && currentChatUserId !== userId) {
                const oldRoom = [currentLoggedInUserId, parseInt(currentChatUserId)].sort().join('-');
                socket.emit('leave_chat', { user_id: currentLoggedInUserId, room: oldRoom });
                console.log(`Left old room: ${oldRoom}`);
            }

            currentChatUserId = userId;
            currentChatUserName = userName;
            chatDisplay.innerHTML = `<p class="text-center text-muted">Loading chat with ${userName}...</p>`;

            // Join the SocketIO room for this chat
            const room = [currentLoggedInUserId, parseInt(userId)].sort().join('-'); // Ensure userId is integer for sorting
            socket.emit('join_chat', { user_id: currentLoggedInUserId, room: room });
            console.log(`Joined new room: ${room}`);

            // Fetch existing messages for this chat via AJAX
            fetch(`/get_messages/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(messages => {
                    chatDisplay.innerHTML = ''; // Clear existing messages
                    if (messages.length === 0) {
                        chatDisplay.innerHTML = `<p class="text-center text-muted">No messages yet with ${userName}.</p>`;
                    } else {
                        messages.forEach(msg => {
                            addMessageToDisplay(msg.message, msg.sender_id, msg.timestamp);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching messages:', error);
                    chatDisplay.innerHTML = `<p class="text-center text-danger">Error loading messages: ${error.message}</p>`;
                });
        }

        // Event listener for sending messages
        sendButton.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default form submission behavior
            const message = messageInput.value.trim();
            if (message && currentChatUserId) {
                console.log(`Attempting to send message to ${currentChatUserName} (ID: ${currentChatUserId}): ${message}`);
                
                // Emit message to server
                socket.emit('send_message', {
                    sender_id: currentLoggedInUserId,
                    recipient_id: parseInt(currentChatUserId),
                    message: message
                });

                // Local Echo: Add message to display immediately
                const now = new Date();
                addMessageToDisplay(message, currentLoggedInUserId, now.toISOString());
                messageInput.value = ''; // Clear input field
            } else if (!currentChatUserId) {
                alert('Please select a chat to send a message.');
            }
        });

        // Listen for 'receive_message' events from the server
        socket.on('receive_message', function(data) {
            console.log('Received message from server:', data);

            // Only display messages that are NOT from the current user AND are for the currently open chat
            // This prevents duplicate messages if local echo is used.
            // Also ensures messages are displayed only if the correct chat is open.
            if (data.sender_id != currentLoggedInUserId && 
                (data.sender_id == currentChatUserId || data.recipient_id == currentChatUserId)) {
                
                addMessageToDisplay(data.message, data.sender_id, data.timestamp);
            }
            // If the message is from me, it means it's the server echoing my own message.
            // We already displayed it with Local Echo, so no action needed here.
            else if (data.sender_id == currentLoggedInUserId && data.recipient_id == currentChatUserId) {
                console.log("My own message echoed by server, already displayed locally.");
            }
        });

        // Socket.IO connection events
        socket.on('connect', function() {
            console.log('Connected to WebSocket');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from WebSocket');
        });

        // Handle errors emitted from the server
        socket.on('error', function(data) {
            console.error('Socket Error:', data.message);
            alert('Error: ' + data.message);
        });
    </script>
</body>
</html>